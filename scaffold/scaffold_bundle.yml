version: 1
description: 'Website mapping MVP scaffold: new mapping modules + minimal integration
  into androidApp.'
new_files:
- path: kmp/mapping/core/build.gradle.kts
  content: |
    plugins {
        kotlin("multiplatform")
        kotlin("plugin.serialization")
    }
    
    kotlin {
        jvm()
        
        sourceSets {
            val commonMain by getting {
                dependencies {
                    implementation("org.jetbrains.kotlinx:kotlinx-serialization-json:1.6.2")
                    implementation("org.jetbrains.kotlinx:kotlinx-datetime:0.6.1")
                }
            }
        }
    }
- path: kmp/mapping/core/src/commonMain/kotlin/de/kolping/cockpit/mapping/core/RecordChain.kt
  content: "package de.kolping.cockpit.mapping.core\n\nimport kotlinx.serialization.Serializable\n\
    \n@Serializable\ndata class RecordChain(\n    val id: String,\n    val name: String,\n\
    \    val rootNodeId: String? = null,\n)\n\n@Serializable\ndata class ChainPoint(\n\
    \    val id: String,\n    val name: String,\n    val url: String,\n    val urlPattern:\
    \ String? = null,\n    val tags: List<String> = emptyList(),\n    val signature:\
    \ String? = null,\n    val isHub: Boolean = false,\n)\n\n@Serializable\ndata class\
    \ ChainEdge(\n    val id: String,\n    val fromNodeId: String,\n    val toNodeId:\
    \ String,\n    val label: String? = null,\n    val createdBy: CreatedBy = CreatedBy.AUTO,\n\
    \    val reason: String? = null,\n)\n\n@Serializable\nenum class CreatedBy { MANUAL,\
    \ AUTO }\n"
- path: kmp/mapping/core/src/commonMain/kotlin/de/kolping/cockpit/mapping/core/RecordingSession.kt
  content: "package de.kolping.cockpit.mapping.core\n\nimport kotlinx.serialization.Serializable\n\
    \n@Serializable\ndata class RecordingSession(\n    val id: String,\n    val startedAtEpochMs:\
    \ Long,\n    val endedAtEpochMs: Long? = null,\n    val targetUrl: String? = null,\n\
    \    val filters: CaptureFilters = CaptureFilters(),\n    val events: List<Event>\
    \ = emptyList(),\n)\n\n@Serializable\ndata class CaptureFilters(\n    val hostAllowlist:\
    \ List<String> = emptyList(),\n    val captureJsonBodies: Boolean = true,\n  \
    \  val maxBodyBytes: Int = 256_000,\n    val redact: Boolean = true,\n)\n\n@Serializable\n\
    sealed class Event {\n    abstract val tsEpochMs: Long\n\n    @Serializable\n\
    \    data class Navigation(\n        override val tsEpochMs: Long,\n        val\
    \ url: String,\n        val phase: Phase,\n    ) : Event()\n\n    @Serializable\n\
    \    data class NetworkRequest(\n        override val tsEpochMs: Long,\n     \
    \   val id: String,\n        val method: String,\n        val url: String,\n \
    \       val headers: Map<String, String> = emptyMap(),\n        val body: String?\
    \ = null,\n    ) : Event()\n\n    @Serializable\n    data class NetworkResponse(\n\
    \        override val tsEpochMs: Long,\n        val requestId: String,\n     \
    \   val status: Int,\n        val headers: Map<String, String> = emptyMap(),\n\
    \        val body: String? = null,\n        val contentType: String? = null,\n\
    \        val graphqlOperationName: String? = null,\n        val moodleAjaxMethod:\
    \ String? = null,\n    ) : Event()\n\n    @Serializable\n    data class Marker(\n\
    \        override val tsEpochMs: Long,\n        val name: String,\n    ) : Event()\n\
    \n    @Serializable\n    enum class Phase { STARTED, FINISHED }\n}\n"
- path: kmp/mapping/core/src/commonMain/kotlin/de/kolping/cockpit/mapping/core/AutoMappingEngine.kt
  content: "package de.kolping.cockpit.mapping.core\n\n/**\n * MVP auto-mapping heuristics:\n\
    \ * - resolve/create nodes by normalized URL + request signature\n * - infer parent\
    \ edges; branch from hub/root on context switch or nav click marker\n *\n * This\
    \ is intentionally minimal: explainable + reversible.\n */\nclass AutoMappingEngine\
    \ {\n    data class Inference(val parentNodeId: String?, val reason: String)\n\
    \n    fun inferParent(\n        lastActiveNodeId: String?,\n        closestHubAncestorId:\
    \ String?,\n        isNewNodeHub: Boolean,\n        isNavClick: Boolean,\n   \
    \     isContextSwitch: Boolean,\n    ): Inference {\n        if (isNewNodeHub)\
    \ return Inference(parentNodeId = null, reason = \"HUB_MATCH\")\n        if (isNavClick)\
    \ return Inference(parentNodeId = closestHubAncestorId, reason = \"NAV_CLICK\"\
    )\n        if (isContextSwitch) return Inference(parentNodeId = closestHubAncestorId,\
    \ reason = \"CONTEXT_SWITCH\")\n        return Inference(parentNodeId = lastActiveNodeId,\
    \ reason = \"LINEAR\")\n    }\n}\n"
- path: kmp/mapping/core/src/commonMain/kotlin/de/kolping/cockpit/mapping/core/Redaction.kt
  content: "package de.kolping.cockpit.mapping.core\n\nobject Redaction {\n    private\
    \ val sensitiveHeaderKeys = setOf(\"authorization\", \"cookie\", \"set-cookie\"\
    )\n    private val sensitiveJsonKeys = setOf(\n        \"access_token\",\"refresh_token\"\
    ,\"id_token\",\"code\",\"state\",\"nonce\",\"session_state\"\n    )\n\n    fun\
    \ redactHeaders(headers: Map<String, String>): Map<String, String> =\n       \
    \ headers.mapValues { (k, v) -> if (k.lowercase() in sensitiveHeaderKeys) \"<redacted>\"\
    \ else v }\n\n    fun redactJsonLike(text: String): String {\n        // very\
    \ lightweight MVP redaction: mask common token keys in JSON-ish bodies\n     \
    \   var out = text\n        for (k in sensitiveJsonKeys) {\n            out =\
    \ out.replace(Regex(\"(\\\"$k\\\"\\s*:\\s*)\\\"[^\\\"]*\\\"\"), \"$1\\\"<redacted>\\\
    \"\"\n)\n        }\n        return out\n    }\n}\n"
- path: kmp/mapping/core/src/commonMain/kotlin/de/kolping/cockpit/mapping/core/ExportBundle.kt
  content: "package de.kolping.cockpit.mapping.core\n\nimport kotlinx.serialization.encodeToString\n\
    import kotlinx.serialization.json.Json\n\nobject ExportBundle {\n    private val\
    \ json = Json { prettyPrint = true; encodeDefaults = true }\n\n    fun sessionJson(session:\
    \ RecordingSession): String = json.encodeToString(session)\n}\n"
- path: kmp/mapping/android/build.gradle.kts
  content: |
    plugins {
        id("com.android.library")
        kotlin("android")
    }
    
    android {
        namespace = "de.kolping.cockpit.mapping.android"
        compileSdk = 34
        
        defaultConfig {
            minSdk = 26
        }
        
        compileOptions {
            sourceCompatibility = JavaVersion.VERSION_17
            targetCompatibility = JavaVersion.VERSION_17
        }
        
        kotlinOptions {
            jvmTarget = "17"
        }
        
        buildFeatures {
            compose = true
        }
        
        composeOptions {
            kotlinCompilerExtensionVersion = "1.5.8"
        }
    }
    
    dependencies {
        implementation(project(":mapping:core"))
        implementation("androidx.compose.material3:material3:1.2.0")
        implementation("androidx.compose.ui:ui:1.6.0")
        implementation("androidx.compose.foundation:foundation:1.6.0")
        implementation("androidx.activity:activity-compose:1.8.2")
    }
- path: kmp/mapping/android/src/main/java/de/kolping/cockpit/mapping/android/ui/RecorderScreen.kt
  content: "package de.kolping.cockpit.mapping.android.ui\n\nimport android.annotation.SuppressLint\n\
    import android.webkit.WebView\nimport androidx.compose.foundation.layout.*\nimport\
    \ androidx.compose.material3.*\nimport androidx.compose.runtime.*\nimport androidx.compose.ui.Modifier\n\
    import androidx.compose.ui.viewinterop.AndroidView\nimport de.kolping.cockpit.mapping.android.web.RecorderWebViewClient\n\
    \n@SuppressLint(\"SetJavaScriptEnabled\")\n@Composable\nfun RecorderScreen(\n\
    \    onBack: () -> Unit,\n    modifier: Modifier = Modifier,\n) {\n    var isRecording\
    \ by remember { mutableStateOf(false) }\n    var currentUrl by remember { mutableStateOf(\"\
    \") }\n\n    Scaffold(\n        topBar = {\n            TopAppBar(\n         \
    \       title = { Text(\"Recorder\") },\n                navigationIcon = { TextButton(onClick\
    \ = onBack) { Text(\"Back\") } },\n                actions = {\n             \
    \       TextButton(onClick = { isRecording = !isRecording }) {\n             \
    \           Text(if (isRecording) \"Stop\" else \"Record\")\n                \
    \    }\n                }\n            )\n        }\n    ) { padding ->\n    \
    \    Column(modifier = modifier.fillMaxSize().padding(padding)) {\n          \
    \  if (currentUrl.isNotBlank()) {\n                Text(currentUrl, style = MaterialTheme.typography.bodySmall)\n\
    \            }\n            AndroidView(\n                factory = { ctx ->\n\
    \                    WebView(ctx).apply {\n                        settings.javaScriptEnabled\
    \ = true\n                        settings.domStorageEnabled = true\n        \
    \                webViewClient = RecorderWebViewClient(\n                    \
    \        isRecordingProvider = { isRecording },\n                            onUrlChanged\
    \ = { currentUrl = it }\n                        )\n                        loadUrl(\"\
    https://portal.kolping-hochschule.de/my/\")\n                    }\n         \
    \       },\n                modifier = Modifier.fillMaxSize()\n            )\n\
    \        }\n    }\n}\n"
- path: kmp/mapping/android/src/main/java/de/kolping/cockpit/mapping/android/web/RecorderWebViewClient.kt
  content: "package de.kolping.cockpit.mapping.android.web\n\nimport android.webkit.WebResourceRequest\n\
    import android.webkit.WebView\nimport android.webkit.WebViewClient\nimport de.kolping.cockpit.mapping.android.web.js.InjectionScripts\n\
    \nclass RecorderWebViewClient(\n    private val isRecordingProvider: () -> Boolean,\n\
    \    private val onUrlChanged: (String) -> Unit,\n) : WebViewClient() {\n\n  \
    \  override fun shouldOverrideUrlLoading(view: WebView?, request: WebResourceRequest?):\
    \ Boolean {\n        val url = request?.url?.toString() ?: return false\n    \
    \    onUrlChanged(url)\n        return false\n    }\n\n    override fun onPageFinished(view:\
    \ WebView?, url: String?) {\n        super.onPageFinished(view, url)\n       \
    \ val u = url ?: return\n        onUrlChanged(u)\n\n        if (!isRecordingProvider())\
    \ return\n\n        // MVP: inject JS to capture fetch/xhr (in-memory only for\
    \ now)\n        view?.evaluateJavascript(InjectionScripts.CAPTURE_NETWORK, null)\n\
    \    }\n}\n"
- path: kmp/mapping/android/src/main/java/de/kolping/cockpit/mapping/android/web/js/InjectionScripts.kt
  content: "package de.kolping.cockpit.mapping.android.web.js\n\nobject InjectionScripts\
    \ {\n    // MVP: wrap fetch & XHR and emit console logs.\n    // Next iteration:\
    \ send events to Android via addJavascriptInterface bridge.\n    const val CAPTURE_NETWORK\
    \ = \"\"\"\n(function(){\n  if(window.__kolpingRecorderInstalled) return;\n  window.__kolpingRecorderInstalled\
    \ = true;\n\n  const origFetch = window.fetch;\n  window.fetch = async function(){\n\
    \    const url = arguments[0];\n    try { console.debug('[RECORDER][fetch]', url);\
    \ } catch(e) {}\n    return await origFetch.apply(this, arguments);\n  };\n\n\
    \  const XHR = XMLHttpRequest.prototype;\n  const origOpen = XHR.open;\n  XHR.open\
    \ = function(method, url){\n    this.__rec_method = method;\n    this.__rec_url\
    \ = url;\n    return origOpen.apply(this, arguments);\n  };\n  const origSend\
    \ = XHR.send;\n  XHR.send = function(body){\n    try { console.debug('[RECORDER][xhr]',\
    \ this.__rec_method, this.__rec_url); } catch(e) {}\n    return origSend.apply(this,\
    \ arguments);\n  };\n})();\n\"\"\"\n}\n"
- path: kmp/recorder/app/build.gradle.kts
  content: |
    plugins {
        id("com.android.application")
        kotlin("android")
    }
    
    android {
        namespace = "de.kolping.cockpit.recorderapp"
        compileSdk = 34
        
        defaultConfig {
            applicationId = "de.kolping.cockpit.recorderapp"
            minSdk = 26
            targetSdk = 34
            versionCode = 1
            versionName = "0.1.0"
        }
        
        compileOptions {
            sourceCompatibility = JavaVersion.VERSION_17
            targetCompatibility = JavaVersion.VERSION_17
        }
        
        kotlinOptions {
            jvmTarget = "17"
        }
        
        buildFeatures {
            compose = true
        }
        
        composeOptions {
            kotlinCompilerExtensionVersion = "1.5.8"
        }
    }
    
    dependencies {
        implementation(project(":mapping:android"))
        implementation("androidx.activity:activity-compose:1.8.2")
        implementation("androidx.compose.ui:ui:1.6.0")
        implementation("androidx.compose.material3:material3:1.2.0")
    }
- path: kmp/recorder/app/src/main/AndroidManifest.xml
  content: "<manifest xmlns:android=\"http://schemas.android.com/apk/res/android\"\
    >\n  <application android:label=\"RecorderApp\">\n    <activity android:name=\"\
    .RecorderAppActivity\" android:exported=\"true\">\n      <intent-filter>\n   \
    \     <action android:name=\"android.intent.action.MAIN\" />\n        <category\
    \ android:name=\"android.intent.category.LAUNCHER\" />\n      </intent-filter>\n\
    \    </activity>\n  </application>\n</manifest>\n"
- path: kmp/recorder/app/src/main/java/de/kolping/cockpit/recorderapp/RecorderAppActivity.kt
  content: "package de.kolping.cockpit.recorderapp\n\nimport android.os.Bundle\nimport\
    \ androidx.activity.ComponentActivity\nimport androidx.activity.compose.setContent\n\
    import de.kolping.cockpit.mapping.android.ui.RecorderScreen\n\nclass RecorderAppActivity\
    \ : ComponentActivity() {\n    override fun onCreate(savedInstanceState: Bundle?)\
    \ {\n        super.onCreate(savedInstanceState)\n        setContent {\n      \
    \      RecorderScreen(onBack = { /* no-op */ })\n        }\n    }\n}\n"
patches:
# Patch 1: Add new module includes to settings.gradle.kts
# Line 20 is empty, 21=include(":shared"), 22=include(":androidApp")
- id: settings_includes
  diff: |
    --- a/kmp/settings.gradle.kts
    +++ b/kmp/settings.gradle.kts
    @@ -20,3 +20,6 @@
     
     include(":shared")
     include(":androidApp")
    +include(":mapping:core")
    +include(":mapping:android")
    +include(":recorder:app")

# Patch 2: Add mapping dependencies to androidApp/build.gradle.kts
# Line 58=dependencies {, 59=implementation(project(":shared"))
- id: androidApp_deps
  diff: |
    --- a/kmp/androidApp/build.gradle.kts
    +++ b/kmp/androidApp/build.gradle.kts
    @@ -58,6 +58,8 @@
     dependencies {
         implementation(project(":shared"))
    +    implementation(project(":mapping:core"))
    +    implementation(project(":mapping:android"))
         
         // Kotlin
         implementation(libs.kotlin.stdlib)

# Patch 3: Add RecorderScreen import after org.koin import (line 14)
- id: mainactivity_import
  diff: |
    --- a/kmp/androidApp/src/main/java/de/kolping/cockpit/android/MainActivity.kt
    +++ b/kmp/androidApp/src/main/java/de/kolping/cockpit/android/MainActivity.kt
    @@ -14,6 +14,7 @@
     import org.koin.android.ext.android.inject
     
    +import de.kolping.cockpit.mapping.android.ui.RecorderScreen
     class MainActivity : ComponentActivity() {

# Patch 4: Add onNavigateToRecorder param to HomeScreen call (line 67-68)
- id: mainactivity_homescreen_param
  diff: |
    --- a/kmp/androidApp/src/main/java/de/kolping/cockpit/android/MainActivity.kt
    +++ b/kmp/androidApp/src/main/java/de/kolping/cockpit/android/MainActivity.kt
    @@ -66,6 +66,7 @@
         
         Screen.Home -> {
             HomeScreen(
    +            onNavigateToRecorder = { currentScreen = Screen.Recorder },
                 onNavigateToModuleDetail = { moduleId ->
                     selectedModuleId = moduleId
                     previousScreen = Screen.Home

# Patch 5: Add Screen.Recorder case after Screen.OfflineLibrary (before PdfViewer, ~line 143-144)
- id: mainactivity_recorder_case
  diff: |
    --- a/kmp/androidApp/src/main/java/de/kolping/cockpit/android/MainActivity.kt
    +++ b/kmp/androidApp/src/main/java/de/kolping/cockpit/android/MainActivity.kt
    @@ -143,6 +143,10 @@
             )
         }
         
    +    Screen.Recorder -> {
    +        RecorderScreen(onBack = { currentScreen = Screen.Home })
    +    }
    +
         Screen.PdfViewer -> {
             selectedFilePath?.let { filePath ->
                 PdfViewerScreen(

# Patch 6: Add Screen.Recorder object to sealed class (line 188-190)
- id: mainactivity_screen_sealed
  diff: |
    --- a/kmp/androidApp/src/main/java/de/kolping/cockpit/android/MainActivity.kt
    +++ b/kmp/androidApp/src/main/java/de/kolping/cockpit/android/MainActivity.kt
    @@ -187,4 +187,5 @@
         object ModuleDetail : Screen()
         object OfflineLibrary : Screen()
         object PdfViewer : Screen()
    +    object Recorder : Screen()
     }

# Patch 7: Add onNavigateToRecorder param to HomeScreen function (line 26-27)
- id: homescreen_recorder_param
  diff: |
    --- a/kmp/androidApp/src/main/java/de/kolping/cockpit/android/ui/screens/HomeScreen.kt
    +++ b/kmp/androidApp/src/main/java/de/kolping/cockpit/android/ui/screens/HomeScreen.kt
    @@ -25,6 +25,7 @@
     @Composable
     fun HomeScreen(
    +    onNavigateToRecorder: () -> Unit = {},
         onNavigateToModuleDetail: (String) -> Unit = {},
         onNavigateToCalendar: () -> Unit = {},
         onNavigateToOfflineLibrary: () -> Unit = {},
