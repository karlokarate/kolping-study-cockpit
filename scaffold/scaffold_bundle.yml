version: 1
description: 'Website mapping MVP scaffold: new mapping modules + minimal integration
  into androidApp.'
new_files:
- path: kmp/mapping/core/build.gradle.kts
  content: |
    plugins {
        kotlin("multiplatform")
        kotlin("plugin.serialization")
    }
    
    kotlin {
        jvm()
        
        sourceSets {
            val commonMain by getting {
                dependencies {
                    implementation("org.jetbrains.kotlinx:kotlinx-serialization-json:1.6.2")
                    implementation("org.jetbrains.kotlinx:kotlinx-datetime:0.6.1")
                }
            }
        }
    }
- path: kmp/mapping/core/src/commonMain/kotlin/de/kolping/cockpit/mapping/core/RecordChain.kt
  content: |
    package de.kolping.cockpit.mapping.core
    
    import kotlinx.serialization.Serializable
    
    @Serializable
    data class RecordChain(
        val id: String,
        val name: String,
        val rootNodeId: String? = null,
    )
    
    @Serializable
    data class ChainPoint(
        val id: String,
        val name: String,
        val url: String,
        val urlPattern: String? = null,
        val tags: List<String> = emptyList(),
        val signature: String? = null,
        val isHub: Boolean = false,
    )
    
    @Serializable
    data class ChainEdge(
        val id: String,
        val fromNodeId: String,
        val toNodeId: String,
        val label: String? = null,
        val createdBy: CreatedBy = CreatedBy.AUTO,
        val reason: String? = null,
    )
    
    @Serializable
    enum class CreatedBy { MANUAL, AUTO }
- path: kmp/mapping/core/src/commonMain/kotlin/de/kolping/cockpit/mapping/core/RecordingSession.kt
  content: |
    package de.kolping.cockpit.mapping.core
    
    import kotlinx.serialization.Serializable
    
    @Serializable
    data class RecordingSession(
        val id: String,
        val startedAtEpochMs: Long,
        val endedAtEpochMs: Long? = null,
        val targetUrl: String? = null,
        val filters: CaptureFilters = CaptureFilters(),
        val events: List<Event> = emptyList(),
    )
    
    @Serializable
    data class CaptureFilters(
        val hostAllowlist: List<String> = emptyList(),
        val captureJsonBodies: Boolean = true,
        val maxBodyBytes: Int = 256_000,
        val redact: Boolean = true,
    )
    
    @Serializable
    sealed class Event {
        abstract val tsEpochMs: Long
    
        @Serializable
        data class Navigation(
            override val tsEpochMs: Long,
            val url: String,
            val phase: Phase,
        ) : Event()
    
        @Serializable
        data class NetworkRequest(
            override val tsEpochMs: Long,
            val id: String,
            val method: String,
            val url: String,
            val headers: Map<String, String> = emptyMap(),
            val body: String? = null,
        ) : Event()
    
        @Serializable
        data class NetworkResponse(
            override val tsEpochMs: Long,
            val requestId: String,
            val status: Int,
            val headers: Map<String, String> = emptyMap(),
            val body: String? = null,
            val contentType: String? = null,
            val graphqlOperationName: String? = null,
            val moodleAjaxMethod: String? = null,
        ) : Event()
    
        @Serializable
        data class Marker(
            override val tsEpochMs: Long,
            val name: String,
        ) : Event()
    
        @Serializable
        enum class Phase { STARTED, FINISHED }
    }
- path: kmp/mapping/core/src/commonMain/kotlin/de/kolping/cockpit/mapping/core/AutoMappingEngine.kt
  content: |
    package de.kolping.cockpit.mapping.core
    
    /**
     * MVP auto-mapping heuristics:
     * - resolve/create nodes by normalized URL + request signature
     * - infer parent edges; branch from hub/root on context switch or nav click marker
     *
     * This is intentionally minimal: explainable + reversible.
     */
    class AutoMappingEngine {
        data class Inference(val parentNodeId: String?, val reason: String)
    
        fun inferParent(
            lastActiveNodeId: String?,
            closestHubAncestorId: String?,
            isNewNodeHub: Boolean,
            isNavClick: Boolean,
            isContextSwitch: Boolean,
        ): Inference {
            if (isNewNodeHub) return Inference(parentNodeId = null, reason = "HUB_MATCH")
            if (isNavClick) return Inference(parentNodeId = closestHubAncestorId, reason = "NAV_CLICK")
            if (isContextSwitch) return Inference(parentNodeId = closestHubAncestorId, reason = "CONTEXT_SWITCH")
            return Inference(parentNodeId = lastActiveNodeId, reason = "LINEAR")
        }
    }
- path: kmp/mapping/core/src/commonMain/kotlin/de/kolping/cockpit/mapping/core/Redaction.kt
  content: |
    package de.kolping.cockpit.mapping.core
    
    object Redaction {
        private val sensitiveHeaderKeys = setOf("authorization", "cookie", "set-cookie")
        private val sensitiveJsonKeys = setOf(
            "access_token", "refresh_token", "id_token", "code", "state", "nonce", "session_state"
        )
    
        fun redactHeaders(headers: Map<String, String>): Map<String, String> =
            headers.mapValues { (k, v) -> if (k.lowercase() in sensitiveHeaderKeys) "<redacted>" else v }
    
        fun redactJsonLike(text: String): String {
            // very lightweight MVP redaction: mask common token keys in JSON-ish bodies
            var out = text
            for (k in sensitiveJsonKeys) {
                // Use simple string matching instead of regex for KMP compatibility
                val pattern = "\"$k\":"
                val replacement = "\"$k\":\"<redacted>\""
                if (out.contains(pattern)) {
                    // Find the key and replace the following quoted value
                    val keyIndex = out.indexOf(pattern)
                    if (keyIndex >= 0) {
                        val afterKey = keyIndex + pattern.length
                        // Skip whitespace
                        var valueStart = afterKey
                        while (valueStart < out.length && out[valueStart].isWhitespace()) valueStart++
                        // Check if it's a quoted string value
                        if (valueStart < out.length && out[valueStart] == '"') {
                            val valueEnd = out.indexOf('"', valueStart + 1)
                            if (valueEnd > valueStart) {
                                out = out.substring(0, valueStart) + "\"<redacted>\"" + out.substring(valueEnd + 1)
                            }
                        }
                    }
                }
            }
            return out
        }
    }
- path: kmp/mapping/core/src/commonMain/kotlin/de/kolping/cockpit/mapping/core/ExportBundle.kt
  content: |
    package de.kolping.cockpit.mapping.core
    
    import kotlinx.serialization.encodeToString
    import kotlinx.serialization.json.Json
    
    object ExportBundle {
        private val json = Json { prettyPrint = true; encodeDefaults = true }
    
        fun sessionJson(session: RecordingSession): String = json.encodeToString(session)
    }
- path: kmp/mapping/android/build.gradle.kts
  content: |
    plugins {
        id("com.android.library")
        kotlin("android")
    }
    
    android {
        namespace = "de.kolping.cockpit.mapping.android"
        compileSdk = 34
        
        defaultConfig {
            minSdk = 26
        }
        
        compileOptions {
            sourceCompatibility = JavaVersion.VERSION_17
            targetCompatibility = JavaVersion.VERSION_17
        }
        
        kotlinOptions {
            jvmTarget = "17"
        }
        
        buildFeatures {
            compose = true
        }
        
        composeOptions {
            kotlinCompilerExtensionVersion = "1.5.8"
        }
    }
    
    dependencies {
        implementation(project(":mapping:core"))
        implementation("androidx.compose.material3:material3:1.2.0")
        implementation("androidx.compose.ui:ui:1.6.0")
        implementation("androidx.compose.foundation:foundation:1.6.0")
        implementation("androidx.activity:activity-compose:1.8.2")
    }
- path: kmp/mapping/android/src/main/java/de/kolping/cockpit/mapping/android/ui/RecorderScreen.kt
  content: |
    package de.kolping.cockpit.mapping.android.ui
    
    import android.annotation.SuppressLint
    import android.webkit.WebView
    import androidx.compose.foundation.layout.*
    import androidx.compose.material3.*
    import androidx.compose.runtime.*
    import androidx.compose.ui.Modifier
    import androidx.compose.ui.viewinterop.AndroidView
    import de.kolping.cockpit.mapping.android.web.RecorderWebViewClient
    
    @SuppressLint("SetJavaScriptEnabled")
    @Composable
    fun RecorderScreen(
        onBack: () -> Unit,
        modifier: Modifier = Modifier,
    ) {
        var isRecording by remember { mutableStateOf(false) }
        var currentUrl by remember { mutableStateOf("") }
    
        Scaffold(
            topBar = {
                TopAppBar(
                    title = { Text("Recorder") },
                    navigationIcon = { TextButton(onClick = onBack) { Text("Back") } },
                    actions = {
                        TextButton(onClick = { isRecording = !isRecording }) {
                            Text(if (isRecording) "Stop" else "Record")
                        }
                    }
                )
            }
        ) { padding ->
            Column(modifier = modifier.fillMaxSize().padding(padding)) {
                if (currentUrl.isNotBlank()) {
                    Text(currentUrl, style = MaterialTheme.typography.bodySmall)
                }
                AndroidView(
                    factory = { ctx ->
                        WebView(ctx).apply {
                            settings.javaScriptEnabled = true
                            settings.domStorageEnabled = true
                            webViewClient = RecorderWebViewClient(
                                isRecordingProvider = { isRecording },
                                onUrlChanged = { currentUrl = it }
                            )
                            loadUrl("https://portal.kolping-hochschule.de/my/")
                        }
                    },
                    modifier = Modifier.fillMaxSize()
                )
            }
        }
    }
- path: kmp/mapping/android/src/main/java/de/kolping/cockpit/mapping/android/web/RecorderWebViewClient.kt
  content: |
    package de.kolping.cockpit.mapping.android.web
    
    import android.webkit.WebResourceRequest
    import android.webkit.WebView
    import android.webkit.WebViewClient
    import de.kolping.cockpit.mapping.android.web.js.InjectionScripts
    
    class RecorderWebViewClient(
        private val isRecordingProvider: () -> Boolean,
        private val onUrlChanged: (String) -> Unit,
    ) : WebViewClient() {
    
        override fun shouldOverrideUrlLoading(view: WebView?, request: WebResourceRequest?): Boolean {
            val url = request?.url?.toString() ?: return false
            onUrlChanged(url)
            return false
        }
    
        override fun onPageFinished(view: WebView?, url: String?) {
            super.onPageFinished(view, url)
            val u = url ?: return
            onUrlChanged(u)
    
            if (!isRecordingProvider()) return
    
            // MVP: inject JS to capture fetch/xhr (in-memory only for now)
            view?.evaluateJavascript(InjectionScripts.CAPTURE_NETWORK, null)
        }
    }
- path: kmp/mapping/android/src/main/java/de/kolping/cockpit/mapping/android/web/js/InjectionScripts.kt
  content: |
    package de.kolping.cockpit.mapping.android.web.js
    
    object InjectionScripts {
        // MVP: wrap fetch & XHR and emit console logs.
        // Next iteration: send events to Android via addJavascriptInterface bridge.
        const val CAPTURE_NETWORK = """
    (function(){
      if(window.__kolpingRecorderInstalled) return;
      window.__kolpingRecorderInstalled = true;
    
      const origFetch = window.fetch;
      window.fetch = async function(){
        const url = arguments[0];
        try { console.debug('[RECORDER][fetch]', url); } catch(e) {}
        return await origFetch.apply(this, arguments);
      };
    
      const XHR = XMLHttpRequest.prototype;
      const origOpen = XHR.open;
      XHR.open = function(method, url){
        this.__rec_method = method;
        this.__rec_url = url;
        return origOpen.apply(this, arguments);
      };
      const origSend = XHR.send;
      XHR.send = function(body){
        try { console.debug('[RECORDER][xhr]', this.__rec_method, this.__rec_url); } catch(e) {}
        return origSend.apply(this, arguments);
      };
    })();
    """
    }
- path: kmp/recorder/app/build.gradle.kts
  content: |
    plugins {
        id("com.android.application")
        kotlin("android")
    }
    
    android {
        namespace = "de.kolping.cockpit.recorderapp"
        compileSdk = 34
        
        defaultConfig {
            applicationId = "de.kolping.cockpit.recorderapp"
            minSdk = 26
            targetSdk = 34
            versionCode = 1
            versionName = "0.1.0"
        }
        
        compileOptions {
            sourceCompatibility = JavaVersion.VERSION_17
            targetCompatibility = JavaVersion.VERSION_17
        }
        
        kotlinOptions {
            jvmTarget = "17"
        }
        
        buildFeatures {
            compose = true
        }
        
        composeOptions {
            kotlinCompilerExtensionVersion = "1.5.8"
        }
    }
    
    dependencies {
        implementation(project(":mapping:android"))
        implementation("androidx.activity:activity-compose:1.8.2")
        implementation("androidx.compose.ui:ui:1.6.0")
        implementation("androidx.compose.material3:material3:1.2.0")
    }
- path: kmp/recorder/app/src/main/AndroidManifest.xml
  content: |
    <manifest xmlns:android="http://schemas.android.com/apk/res/android">
      <application android:label="RecorderApp">
        <activity android:name=".RecorderAppActivity" android:exported="true">
          <intent-filter>
            <action android:name="android.intent.action.MAIN" />
            <category android:name="android.intent.category.LAUNCHER" />
          </intent-filter>
        </activity>
      </application>
    </manifest>
- path: kmp/recorder/app/src/main/java/de/kolping/cockpit/recorderapp/RecorderAppActivity.kt
  content: |
    package de.kolping.cockpit.recorderapp
    
    import android.os.Bundle
    import androidx.activity.ComponentActivity
    import androidx.activity.compose.setContent
    import de.kolping.cockpit.mapping.android.ui.RecorderScreen
    
    class RecorderAppActivity : ComponentActivity() {
        override fun onCreate(savedInstanceState: Bundle?) {
            super.onCreate(savedInstanceState)
            setContent {
                RecorderScreen(onBack = { /* no-op */ })
            }
        }
    }
patches:
# Patch 1: Add new module includes to settings.gradle.kts
- id: settings_includes
  diff: |
    --- a/kmp/settings.gradle.kts
    +++ b/kmp/settings.gradle.kts
    @@ -20,3 +20,6 @@
     
     include(":shared")
     include(":androidApp")
    +include(":mapping:core")
    +include(":mapping:android")
    +include(":recorder:app")

# Patch 2: Add mapping dependencies to androidApp/build.gradle.kts
- id: androidApp_deps
  diff: |
    --- a/kmp/androidApp/build.gradle.kts
    +++ b/kmp/androidApp/build.gradle.kts
    @@ -58,6 +58,8 @@
     dependencies {
         implementation(project(":shared"))
    +    implementation(project(":mapping:core"))
    +    implementation(project(":mapping:android"))
         
         // Kotlin
         implementation(libs.kotlin.stdlib)

# Patch 3: Add RecorderScreen import after org.koin import (line 14)
- id: mainactivity_import
  diff: |
    --- a/kmp/androidApp/src/main/java/de/kolping/cockpit/android/MainActivity.kt
    +++ b/kmp/androidApp/src/main/java/de/kolping/cockpit/android/MainActivity.kt
    @@ -14,6 +14,7 @@
     import org.koin.android.ext.android.inject
     
    +import de.kolping.cockpit.mapping.android.ui.RecorderScreen
     class MainActivity : ComponentActivity() {

# Patch 4: Add onNavigateToRecorder param to HomeScreen call (line 67-68)
- id: mainactivity_homescreen_param
  diff: |
    --- a/kmp/androidApp/src/main/java/de/kolping/cockpit/android/MainActivity.kt
    +++ b/kmp/androidApp/src/main/java/de/kolping/cockpit/android/MainActivity.kt
    @@ -66,6 +66,7 @@
         
         Screen.Home -> {
             HomeScreen(
    +            onNavigateToRecorder = { currentScreen = Screen.Recorder },
                 onNavigateToModuleDetail = { moduleId ->
                     selectedModuleId = moduleId
                     previousScreen = Screen.Home

# Patch 5: Add Screen.Recorder case after Screen.OfflineLibrary (before PdfViewer)
- id: mainactivity_recorder_case
  diff: |
    --- a/kmp/androidApp/src/main/java/de/kolping/cockpit/android/MainActivity.kt
    +++ b/kmp/androidApp/src/main/java/de/kolping/cockpit/android/MainActivity.kt
    @@ -143,6 +143,10 @@
             )
         }
         
    +    Screen.Recorder -> {
    +        RecorderScreen(onBack = { currentScreen = Screen.Home })
    +    }
    +
         Screen.PdfViewer -> {
             selectedFilePath?.let { filePath ->
                 PdfViewerScreen(

# Patch 6: Add Screen.Recorder object to sealed class (line 188-190)
- id: mainactivity_screen_sealed
  diff: |
    --- a/kmp/androidApp/src/main/java/de/kolping/cockpit/android/MainActivity.kt
    +++ b/kmp/androidApp/src/main/java/de/kolping/cockpit/android/MainActivity.kt
    @@ -187,4 +187,5 @@
         object ModuleDetail : Screen()
         object OfflineLibrary : Screen()
         object PdfViewer : Screen()
    +    object Recorder : Screen()
     }

# Patch 7: Add onNavigateToRecorder param to HomeScreen function (line 26-27)
- id: homescreen_recorder_param
  diff: |
    --- a/kmp/androidApp/src/main/java/de/kolping/cockpit/android/ui/screens/HomeScreen.kt
    +++ b/kmp/androidApp/src/main/java/de/kolping/cockpit/android/ui/screens/HomeScreen.kt
    @@ -25,6 +25,7 @@
     @Composable
     fun HomeScreen(
    +    onNavigateToRecorder: () -> Unit = {},
         onNavigateToModuleDetail: (String) -> Unit = {},
         onNavigateToCalendar: () -> Unit = {},
         onNavigateToOfflineLibrary: () -> Unit = {},
