name: Scaffold Website Mapping MVP

on:
  workflow_dispatch:
    inputs:
      bundle_path:
        description: "Path to scaffold bundle YAML"
        required: true
        default: "scaffold/scaffold_bundle.yml"

jobs:
  scaffold:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for git apply

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Apply scaffold bundle
        run: |
          python scripts/apply_bundle.py "${{ inputs.bundle_path }}"

      - name: Show created files
        run: |
          echo "=== New directories created ==="
          ls -la kmp/mapping/ || echo "mapping/ not found"
          ls -la kmp/recorder/ || echo "recorder/ not found"
          echo "=== Git status ==="
          git status --short

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Smoke build (all modules)
        run: |
          cd kmp
          echo "=== Building mapping:core ==="
          ./gradlew --no-daemon :mapping:core:build
          echo "=== Building mapping:android ==="
          ./gradlew --no-daemon :mapping:android:build
          echo "=== Building recorder:app ==="
          ./gradlew --no-daemon :recorder:app:assembleDebug
          echo "=== Building androidApp ==="
          ./gradlew --no-daemon :androidApp:assembleDebug
          echo "=== All builds successful! ==="

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            feat: Scaffold website mapping MVP

            Adds new modules:
            - mapping:core (KMP multiplatform)
            - mapping:android (Android library)
            - recorder:app (standalone recorder app)

            Integrates RecorderScreen into androidApp.
          title: "feat: Scaffold Website Mapping MVP"
          body: |
            ## Website Mapping MVP Scaffold

            This PR scaffolds the website mapping MVP infrastructure:

            ### New Modules
            - **`:mapping:core`** - KMP multiplatform module with:
              - Models (RecordChain, ChainPoint, ChainEdge, Event, HttpCall)
              - AutoMappingEngine for hub detection and parent inference
              - Signature computation for URL normalization
              - Redaction utilities for sensitive data
              - SchemaDeriver for JSON schema extraction
              - ExportBundle for JSON serialization

            - **`:mapping:android`** - Android library with:
              - RecorderScreen (Compose UI)
              - RecorderController (state management)
              - RecorderWebView with JS injection
              - JsBridge for WebView ↔ Kotlin communication
              - SessionStore for filesystem export

            - **`:recorder:app`** - Standalone recorder app for testing

            ### Integration
            - Adds RecorderScreen navigation to androidApp HomeScreen
            - Adds `Screen.Recorder` to navigation sealed class

            ### Build Verification
            All modules compile successfully ✅

            ---
            *Auto-generated by scaffold workflow*
          branch: "scaffold/website-mapping-mvp"
          delete-branch: true
          labels: |
            enhancement
            scaffold
            automated

      - name: PR Result
        run: |
          echo "=== Pull Request Result ==="
          echo "PR Number: ${{ steps.create-pr.outputs.pull-request-number }}"
          echo "PR URL: ${{ steps.create-pr.outputs.pull-request-url }}"
          echo "PR Created: ${{ steps.create-pr.outputs.pull-request-created }}"
          echo "PR Updated: ${{ steps.create-pr.outputs.pull-request-updated }}"
