name: Android Build

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
      version_name:
        description: 'Version Name (optional, e.g. 1.0.1)'
        required: false
        type: string

  push:
    branches: [main]
    paths:
      - 'kmp/**'
      - '.github/workflows/android-build.yml'

  pull_request:
    branches: [main]
    paths:
      - 'kmp/**'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        run: chmod +x kmp/gradlew

      - name: Determine build type
        id: build-config
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            BUILD_TYPE="${{ github.event.inputs.build_type }}"
            echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
            if [ -n "${{ github.event.inputs.version_name }}" ]; then
              VERSION="${{ github.event.inputs.version_name }}"
              echo "version_name=$VERSION" >> $GITHUB_OUTPUT
            fi
          else
            echo "build_type=debug" >> $GITHUB_OUTPUT
          fi

      - name: Build Debug APK
        if: steps.build-config.outputs.build_type == 'debug'
        continue-on-error: true
        working-directory: kmp
        run: ./gradlew :androidApp:assembleDebug --continue 2>&1 | tee build-output.log || echo "BUILD_FAILED=true" >> $GITHUB_ENV

      - name: Build Release APK
        if: steps.build-config.outputs.build_type == 'release'
        continue-on-error: true
        working-directory: kmp
        run: ./gradlew :androidApp:assembleRelease --continue 2>&1 | tee build-output.log || echo "BUILD_FAILED=true" >> $GITHUB_ENV
        # Note: For signed release builds, configure the following:
        # 1. Add keystore file as GitHub Secret:
        #    ANDROID_KEYSTORE_BASE64
        # 2. Add signing credentials as Secrets:
        #    - ANDROID_KEYSTORE_PASSWORD
        #    - ANDROID_KEY_ALIAS
        #    - ANDROID_KEY_PASSWORD
        # 3. Update androidApp/build.gradle.kts with signingConfigs:
        #    signingConfigs {
        #        release {
        #            storeFile = file("release.keystore")
        #            storePassword = System.getenv("KEYSTORE_PASSWORD")
        #            keyAlias = System.getenv("KEY_ALIAS")
        #            keyPassword = System.getenv("KEY_PASSWORD")
        #        }
        #    }
        # 4. Add step to decode keystore before building:
        #    - name: Decode Keystore
        #      run: |
        #        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | \
        #          base64 -d > kmp/androidApp/release.keystore

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kolping-cockpit-${{ steps.build-config.outputs.build_type }}-apk
          path: kmp/androidApp/build/outputs/apk/${{ steps.build-config.outputs.build_type }}/*.apk
          retention-days: 30

      - name: Upload Build Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports
          path: kmp/androidApp/build/reports/
          retention-days: 7

      - name: Upload Build Output Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-output-log
          path: kmp/build-output.log
          retention-days: 7

      - name: Build Summary
        if: always()
        working-directory: kmp
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          if [ "$BUILD_FAILED" = "true" ]; then
            echo "❌ **Build failed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Error Details:" >> $GITHUB_STEP_SUMMARY
            if [ -f build-output.log ]; then
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -A 5 "FAILURE\|ERROR\|error:" build-output.log | head -100 >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
            exit 1
          else
            echo "✅ **Build succeeded!**" >> $GITHUB_STEP_SUMMARY
          fi
